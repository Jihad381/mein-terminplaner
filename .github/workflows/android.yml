name: Android Build (Release + Debug)

on:

  workflow_dispatch:

  push:

    branches: [ main ]

jobs:

  build-android:

    runs-on: ubuntu-latest

    steps:

      - name: Checkout

        uses: actions/checkout@v4

      - name: Setup Flutter

        uses: subosito/flutter-action@v2

        with:

          flutter-version: '3.22.2' # غيرها حسب إصدار Flutter عندك

      - name: Install dependencies

        run: flutter pub get

      - name: Decode keystore

        if: ${{ secrets.KEYSTORE_BASE64 != '' }}

        run: |

          mkdir -p android/app

          echo "${{ secrets.KEYSTORE_BASE64 }}" | base64 --decode > android/app/release.keystore

      - name: Create key.properties

        if: ${{ secrets.KEYSTORE_BASE64 != '' }}

        run: |

          cat > android/key.properties << 'EOF'

          storePassword=${{ secrets.KEYSTORE_PASSWORD }}

          keyPassword=${{ secrets.KEY_PASSWORD }}

          keyAlias=${{ secrets.KEY_ALIAS }}

          storeFile=app/release.keystore

          EOF

      - name: Build release APK

        if: ${{ secrets.KEYSTORE_BASE64 != '' }}

        run: flutter build apk --release --dart-define=APP_PACKAGE_ID=de.meinterminplaner.app

      - name: Build release AAB

        if: ${{ secrets.KEYSTORE_BASE64 != '' }}

        run: flutter build appbundle --release --dart-define=APP_PACKAGE_ID=de.meinterminplaner.app

      - name: Upload release APK

        if: ${{ secrets.KEYSTORE_BASE64 != '' }}

        uses: actions/upload-artifact@v4

        with:

          name: mein-terminplaner-release-apk

          path: build/app/outputs/flutter-apk/app-release.apk

      - name: Upload release AAB

        if: ${{ secrets.KEYSTORE_BASE64 != '' }}

        uses: actions/upload-artifact@v4

        with:

          name: mein-terminplaner-release-aab

          path: build/app/outputs/bundle/release/app-release.aab 
